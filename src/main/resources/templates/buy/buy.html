<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
<meta charset="UTF-8">
<title>코드네컷</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
<link rel="stylesheet" href="/static/css/stylesheet.css">
</head>
<body>

	 <section class="buyMain d-flex justify-content-center">
        	
			<div class="border border-danger user-box my-2 p-2 rounded-lg ">
				<header class="mainHeader bg-warning d-flex justify-content-between align-items-center" style="width:880px;">		
					<i id="backBtn" class="bi bi-arrow-left-short"></i>
					
					<h3 class="text-center text-dark font-weight-bold">국내 최고의 악기거래 플랫폼입니다.</h3>
					<div>
						<div class="userName" th:if="${session.userId != null}"><span th:text="${session.nickname}" class="text-secondary">ddd</span><span class="text-secondary">님</span></div>
						<a class="text-dark" th:if="${session.userId != null}" id="logoutBtn" href="#">로그아웃</a>
						<a class="loginBtn text-dark" th:unless="${session.userId != null}" href="/user/login-view">로그인</a>
					</div>
				</header>
				<div class="d-flex">
	
					<form action="/buy/search" method="get">
					   <input id="searchInput" type="text" name="text" placeholder="검색" class="form-control">
					</form>
		
					
					<nav class="menu">
						<ul class="navi">	
							<li><a href="#">악기</a>
								<ul class="submenu">
									<li><a href="/buy/search?text=통기타">통기타</a></li>
									<li><a href="/buy/search?text=일렉기타">일렉기타</a></li>
									<li><a href="/buy/search?text=기보드">키보드</a></li>
									<li><a href="/buy/search?text=베이스">베이스</a></li>
									<li><a href="/buy/search?text=드럼">드럼</a></li>
								</ul>
							</li>
							<li><a href="#">엠프</a>
								<ul class="submenu">
									<li><a href="/buy/search?text=마샬">마샬</a></li>
									<li><a href="/buy/search?text=복스">복스</a></li>
									<li><a href="/buy/search?text=펜더">펜더</a></li>
									<li><a href="/buy/search?text=오렌지">오렌지</a></li>
								</ul>
							</li>
							<li><a href="#">장비</a>
								<ul class="submenu">
									<li><a href="/buy/search?text=케이블">케이블</a></li>
									<li><a href="/buy/search?text=오디오인터페이스">오인페</a></li>
									<li><a href="/buy/search?text=이펙터">이펙터</a></li>
									<li><a href="/buy/search?text=페달보드">페달보드</a></li>
								</ul>
							</li>
							<li><a href="#">부속품</a>
							<ul class="submenu">
									<li><a href="/buy/search?text=피크">피크</a></li>
									<li><a href="/buy/search?text=튜너">튜너</a></li>
									<li><a href="/buy/search?text=스텐드">스텐드</a></li>
									<li><a href="/buy/search?text=카포">카포</a></li>
									<li><a href="/buy/search?text=스틱">스틱</a></li>
								</ul>
							</li>
<!-- 로그인 되어있을때만 보이기 --><li th:if="${session.userId != null}"><a href="#">더보기</a>
							<ul class="submenu">
									<li><a th:data-user-id="${session.userId}" id="newBuy" href="#">새 게시물</a></li>
		<!-- 수정, 삭제 -->			<li><a href="/buy/myBuy-view">내 게시물</a></li>
									<li><a id="deleteUserBtn" href="#">탈퇴하기</a></li>
								</ul>
							</li>
						</ul>
						
					</nav>
				</div>
				
				
				<div class="border border-white user-box my-2 p-2 rounded-lg" th:each="buyCard:${buyCardList}">
				<div class="d-flex">
					<span th:text="${buyCard.nickname}" class="font-weight-bold" style="font-size: 25px">닉네임</span>
	<!-- 게시자 정보 --><span th:text="${buyCard.description}" class="ml-4 mt-2">설명</span>
				</div>
				<main class="d-flex align-items-center">
						<article class="buyImg">
							<img th:src="${buyCard.imgPath}">
						</article>
						<div class="buyInfo">
							<span>모델명 : <span th:text="${buyCard.model}">fander</span></span><br>
							<span>구입연도 : <span th:text="${buyCard.buyYear}">2015년</span>년</span><br>
							<span>가격 : <span th:text="${buyCard.price}" class="text-success">100만원</span>만원</span><br>
							<span th:if="${buyCard.status == '판매중'}">판매상태 : <span class="text-danger" th:text="${buyCard.status}">판매중</span></span>
							<span th:unless="${buyCard.status == '판매중'}">판매상태 : <span class="text-success" th:text="${buyCard.status}">판매완료</span></span>
							<button th:if="${buyCard.status != '판매완료'}" th:data-buy-price="${buyCard.price}" th:data-buy-model="${buyCard.model}" th:data-buy-id="${buyCard.buyId}" type="button" class="btn btn-danger btn-block mt-3 font-weight-bold buyBtn">바로구매</button>
							<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
						</div>				
				</main>
				</div>
				
				
				
			</div>
       </section>





		<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js" integrity="sha384-+sLIOodYLS7CIrQpBjl+C7nPvqq+FbNUBDunl/OZv93DB7Ln/533i8e/mZXLi/P+" crossorigin="anonymous"></script>


		
		<script>
		
		
		$(function(){
			
			
			
			
			
		
			$(".buyBtn").on("click", function(){
				   IMP.init("imp20361011"); //고객사 식별코드
				   let priceGet = $(this).data("buy-price") * 10000;
				   let modelGet = $(this).data("buy-model");
				   let buyId = $(this).data("buy-id");

				   IMP.request_pay({
				      pg:"kakaopay",
				      pay_method:"card",
				      amount : priceGet,
				      name: modelGet,
				      merchant_uid:"mid_" + new Date().getTime()
				   }, function(rsp){
				      if(rsp.success){
				         alert("결제 성공! imp_uid: " + rsp.imp_uid);
				         $.ajax({
				        	type:`post`
				        	,url:"/buy/solded"
				        	,data:{"buyId":buyId}
				        	,success(responce){
				        		if(responce.result == "success"){
				        			location.reload();
				        		}
				        		else{
				        			alert("판매상태 변경 실패");
				        		}
				        	}
				        	,error(){
				        		alert("판매상태 변경 에러");
				        	}
				         });
				      } else {
				         alert("결제 실패: " + rsp.error_msg);
				      }
				   });
				});
			
			
			
			
			
			
			$("#newBuy").on("click", function(){
				
				let userId = $(this).data("user-id");
				
				console.log("사용자 아이디 : " + userId);
				
				if(userId == null){
				
					if(confirm("게시물을 올리시려면 로그인 하세요.")){
						location.href="/user/login-view";
					}
					return ;
				}
				location.href="/buy/newBuy-view";
			});
			
			
			
			$("#logoutBtn").on("click", function(){
				if(confirm("로그아웃 하겠습니까?")){
					location.href = "/user/logout";
				}
				
			});
				
			$('.navi>li').mouseover(function(){
  				$(this).find('.submenu').stop().slideDown(500);
  			}).mouseout(function(){
  				$(this).find('.submenu').stop().slideUp(500);
  			});
		});
			
		
		$("#backBtn").on("click", function(){
			location.href="/main-view";
		});
		
		
		/*
		$("#deleteUserBtn").on("click", function(){
			if(confirm("계정을 탈퇴하시겠습니까?")){
				alert("탈퇴완료되었습니다.");
				location.href = "/user/deleteUser";
			}
		});
		*/
		
		</script>
	







</body>
</html>