<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
  <meta charset="UTF-8">
  <title>코드네컷</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
  <link rel="stylesheet" href="/static/css/stylesheet.css">
</head>
<body style="background-color:#000;">

  <section class="buyMain d-flex justify-content-center">
    <div class="border border-danger user-box my-2 p-2 rounded-lg" style="width: 820px; background-color: #1e1e1e; box-shadow: 0 0 30px rgba(255, 255, 255, 0.1);">
      
      <!-- 원래 헤더 유지 -->
      <header class="mainHeader bg-success d-flex justify-content-between align-items-center">      
        <i id="backBtn" class="bi bi-arrow-left-short"></i>
        
        <h3 class="text-center text-dark font-weight-bold" style="margin-left:300px;">음악 일상 나눔</h3>
        <div>
          <div class="userName" th:if="${session.userId != null}">
            <span th:text="${session.nickname}" class="text-secondary">ddd</span><span class="text-secondary">님</span>
          </div>
          <a class="text-dark" th:if="${session.userId != null}" id="logoutBtn" href="#">로그아웃</a>
          <a class="loginBtn text-dark" th:unless="${session.userId != null}" href="/user/login-view">로그인</a>
        </div>
      </header>

      <!-- 더보기 메뉴 원래 유지 -->
      <div class="mt-2 d-flex justify-content-end">
        <ul class="navi">
          <li class="bg-info"><a href="#">더보기</a>
            <ul class="submenu">
              <li><a href="/daily/newDaily-view" class="text-white">새 게시물</a></li>
              <li><a href="/daily/myDaily-view" class="text-white deleteBtn">내 게시물</a></li>
            </ul>
          </li>
        </ul>
      </div>

      <!-- 카드 영역 반복 -->
      <div th:each="dailyCard:${dailyCardList}" class="border border-white user-box my-2 p-3 rounded-lg" style="background-color: #2c2c2c; color: white;">
        <div style="font-size:25px; font-weight:bold;" th:text="${dailyCard.nickname}"></div>
        <div class="input-box border rounded" style="background-color:#1a1a1a; padding: 10px;">

          <article class="dailyListSlider" style="margin-bottom: 15px;">
            <img th:src="${dailyCard.imgPath}" alt="게시물 사진" style="max-width:100%; border-radius: 12px;">
          </article>

          <div th:text="${dailyCard.title}" class="title" style="font-size:20px; font-weight:bold; margin-bottom: 8px;">게시물 제목</div>
          <div th:text="${dailyCard.contents}" class="titleContents" style="margin-bottom: 12px;">게시물 내용</div>

          <div class="listBottom d-flex justify-content-between" style="margin-bottom: 10px;">
            <div>
              <i th:unless="${dailyCard.isLike}" class="bi bi-heart text-danger likeBtn" th:data-daily-id="${dailyCard.dailyId}"></i> 
              <i th:if="${dailyCard.isLike}" class="bi bi-heart-fill text-danger disLikeBtn" th:data-daily-id="${dailyCard.dailyId}"></i>
              <span th:text="${dailyCard.likeCount}" class="likeCount" style="margin-left: 5px;">좋아요 <span>11</span>개</span>                  
            </div>
          </div>

          <div th:each="comment:${dailyCard.commentList}" class="d-flex mb-2" style="background-color: #333; padding: 5px 10px; border-radius: 6px;">
            <h4 th:text="${comment.nickname}" style="font-size: 16px; margin: 0;">dlawltjd</h4>
            <span th:text="${comment.contents}" class="ml-3" style="font-size: 15px;">우하하</span>
            <i th:if="${session.userId == comment.userId}" th:data-comment-id="${comment.commentId}" class="bi bi-trash ml-4 commentDelete" style="cursor:pointer;"></i>
          </div>

          <div class="d-flex mt-2">
            <input th:id="|commentInput${dailyCard.dailyId}|" type="text" class="form-control" style="background-color:#1f1f1f; color:white; border:1px solid #444;">
            <button th:data-daily-id="${dailyCard.dailyId}" class="btn btn-info col-2 comment-btn">게시</button>
          </div>

        </div>
      </div>
    </div>
  </section>

  <!-- 스크립트는 생략하지 않고 동일하게 유지 -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>

    <script>
      
      
      $(function(){
         
         $(".commentDelete").on("click", function(){
            let commentId = $(this).data("comment-id");
            
            console.log("commentId : " + commentId); 
            if(confirm("댓글을 삭제하시겠습니까?")){            
               $.ajax({
                  type:`delete`
                  ,url:"/daily/deleteComment"
                  ,data:{"commentId":commentId}
                  ,success(response){
                     if(response.result == "success"){
                        location.reload();
                     }
                     else{
                        alert("삭제 실패");
                     }
                  }
                  ,error(){
                     alert("댓글 삭제 에러");
                  }
               });
            }
         });
         
         
         
         
         $(".comment-btn").on("click", function(){
            let dailyId = $(this).data("daily-id");
            let contents = $(this).prev().val();
            
            console.log("dailyId : " + dailyId + " contents : " + contents);
            
            $.ajax({
               type:`post`
               ,url:"/daily/comment"
               ,data:{"dailyId":dailyId, "contents":contents}
               ,success(response){
                  if(response.result == "success"){
                     location.reload();
                  }
                  else{
                     alert("댓글 작성 실패");
                  }
               }
               ,error(){
                  alert("댓글 작성 에러");
               }
            });
            
            
         });
         
         
         
         $("#logoutBtn").on("click", function(){
            if(confirm("로그아웃 하겠습니까?")){
               location.href = "/user/logout";
            }
            
         });
            
         $('.navi>li').mouseover(function(){
              $(this).find('.submenu').stop().slideDown(500);
           }).mouseout(function(){
              $(this).find('.submenu').stop().slideUp(500);
           });
      });
         
      
      $("#backBtn").on("click", function(){
         location.href="/main-view";
      });
      
      
        $(".likeBtn").on("click", function(){
            
            
              
              let dailyId = $(this).data("daily-id");
              
              console.log("daily 아이디 : " + dailyId);
               
               $.ajax({
                 type:`post`
                 ,url:"/daily/like"
                 ,data:{"dailyId":dailyId}
               ,success:function(response){
                  if(response.result == "success"){
                     location.reload();
                  }
                  else{
                     alert("좋아요 실패");
                  }
               }
               ,error:function(){
                  alert("좋아요 에러");
               }
               });
            });
           $(".disLikeBtn").on("click", function(){
                      
                     
                     let dailyId = $(this).data("daily-id");
                     
                     console.log("daily 아이디 : " + dailyId);
                      
                      $.ajax({
                        type:`post`
                        ,url:"/daily/dislike"
                        ,data:{"dailyId":dailyId}
                      ,success:function(response){
                         if(response.result == "success"){
                            location.reload();
                         }
                         else{
                            alert("좋아요 실패");
                         }
                      }
                      ,error:function(){
                         alert("좋아요 에러");
                      }
                      });
                   });
      
      
      /*
      $("#deleteUserBtn").on("click", function(){
         if(confirm("계정을 탈퇴하시겠습니까?")){
            alert("탈퇴완료되었습니다.");
            location.href = "/user/deleteUser";
         }
      });
      */
      
      </script>


</body>
</html>